<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Digital Terrain Model Picker</title>
<meta charset="utf-8">
<meta name="format-detection" content="telephone=no">
<meta name="msapplication-tap-highlight" content="no">
<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <link href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css" rel="stylesheet" type="text/css" />
    <link href="//unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" rel="stylesheet" type="text/css" />
    <link href="//unpkg.com/leaflet.elevation@0.0.3/dist/Leaflet.Elevation-0.0.2.css" rel="stylesheet" type="text/css" />
<style>
body {
    margin:0
}
#map {
	position: absolute;
	width: 100%;
	top:0;
	bottom:0;
}
.btn-share {
    font-size:16px;
    text-decoration:none;
    display:block;
    text-align:right;
}
.leaflet-popup.loading .leaflet-popup-content {
    background: no-repeat center center url('data:image/gif;base64,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');
    color:rgba(0,0,0,0.2)
}
#ribbon {
	position: absolute;
	top: 0;
	right: 0;
	height: 100px;
	width: auto;
	border: 0;
	filter: alpha(opacity=80);
	-khtml-opacity: .8;
	-moz-opacity: .8;
	opacity: .8;
    z-index:20000
}
</style>
</head>

<body>

<div id="map">
</div>

<a href="https://github.com/stefanocudini/geotiff-picker"><img id="ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

<script src="//unpkg.com/underscore@1.9.1/underscore.js"></script>
<script src="//unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
<script src="//unpkg.com/leaflet@1.4.0/dist/leaflet-src.js"></script>
<script src="//unpkg.com/clipboard@2.0.4/dist/clipboard.js"></script>
<script src="//unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="//unpkg.com/d3@3.5.17/d3.min.js"></script>
<script src="//unpkg.com/leaflet.elevation@0.0.3/dist/Leaflet.Elevation-0.0.2.min.js"></script>
<script>

var cen = [46.0651,11.1528],
    bbox = [4.493408203125001,43.092960677116295,16.896972656250004,48.94415123418794],
	zom =13;

var markerPick = L.marker(cen,{draggable:true})

function debounce(func, wait, immediate) {
  var timeout;
  return function() {
  	var context = this, args = arguments;
  	clearTimeout(timeout);
  	timeout = setTimeout(() => {
  		timeout = null;
  		if (!immediate) func.apply(context, args);
  	}, wait);
  	if (immediate && !timeout) func.apply(context, args);
  };
}

var data1,data2,data3;
function pickData(loc) {

  return

    data1 && data1.abort();
    data2 && data2.abort();
    data3 && data3.abort();

    const geturl = d => {return `/maps/geotiff-picker/${d.type}?zone=${d.zone}&lat=${d.lat}&lng=${d.lng}`};

    data1 = $.getJSON(geturl({zone: 'italy', type: 'dem', ...loc}));
    data2 = $.getJSON(geturl({zone: 'italy', type: 'aspect', ...loc}));
    data3 = $.getJSON(geturl({zone: 'italy', type: 'slope', ...loc}));

    var $self = $(markerPick._popup._container);

    $self.addClass('loading');

	$.when(data1, data2, data3).done((dem, asp, slo) => {

		var data = {
				lat: loc.lat,
				lng: loc.lng,
				dem: dem[0].val,
				aspect: asp[0].val,
				slope: slo[0].val
			},
            text = JSON.stringify(data,"\t",4);

        $self.removeClass('loading');

		markerPick.bindPopup('<pre>'+text+'</pre><a href="#" class="btn-share">Copy</a>').openPopup();

    	var c = new ClipboardJS($self.find('.btn-share')[0], {
            text: function() {
	            return text;
            }
        }).on('success', e => {
            $self.find('.btn-share').text('Copied!');
            setTimeout(() => {
                $self.find('.btn-share').text('Copy');
            },1000);
        });

	});
}
var baselayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
	subdomains: 'abcd',
	minZoom: 8,
	maxZoom: 16,
	ext: 'png'
});
//L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
var map = L.map('map', {
	center: cen,
	zoom: zom,
	layers: [
        markerPick, baselayer
    ]
}).on('click', e => {
	markerPick.setLatLng(e.latlng);
	pickData(e.latlng);
});

markerPick.bindPopup('Drag it to pick data!').openPopup();

markerPick.on('drag', debounce(e => {

 pickData(e.target.getLatLng())

},25));

/*$.getJSON('italy.geojson').done( geo => {
	L.geoJSON(geo, {
		style: ({fill:false,color:'red'})
	}).addTo(map)
})*/

var controlElevation = new L.Control.Elevation({
  width: 600,
  height: 200,
  position: 'bottomright',
  //collapsed: true
});
map.addControl(controlElevation);


// https://github.com/MrMufflon/Leaflet.Elevation
var layerElevation = L.geoJson([], {
    onEachFeature: controlElevation.addData.bind(controlElevation)
}).addTo(map);

// Initialise the FeatureGroup to store editable layers
var editableLayers = L.featureGroup().addTo(map);

var drawOpts = {
  position: 'topleft',
  draw: {
    polyline: {
    	shapeOptions: {
	        color: '#f357a1',
	        weight: 10
    	}
    },
    circle: false,
    circlemarker: false,
    rectangle: false,
    polygon: false,
    marker: false
  },
  edit: {
    featureGroup: editableLayers,
    remove: true
  }
};

// Initialise the draw control and pass it the FeatureGroup of editable layers
var drawControl = new L.Control.Draw(drawOpts);
map.addControl(drawControl);

var editableLayers = new L.FeatureGroup();
map.addLayer(editableLayers);

map
.on('draw:drawstart', e => {
	markerPick.remove()
})
.on('draw:drawstop', e => {
	markerPick.addTo(map)
})
/*.on('draw:created', e => {
  editableLayers.addLayer(e.layer);
})*/
.on('draw:drawvertex', e => {

//	let geo = e.layer.toGeoJSON();
  let geo = e.layers.toGeoJSON();

  let coordinates = geo.features.map(f => {
    return f.geometry.coordinates
  });

  let georeq = {
    type: 'Feature',
    properties: {},
    geometry: {
      type: 'LineString',
      coordinates
    }
  }

  console.log('REQ',georeq.geometry)

  $.ajax({
    url: 'http://localhost:3000/elevation',
    type: 'POST',
    dataType: 'json',
    contentType: 'application/json; charset=utf-8',
    data: JSON.stringify(georeq),
  }).done(geores => {

    console.log('RES',geores)

    controlElevation.clear()

    layerElevation.addData(geores);

    editableLayers.addLayer(layerElevation);
  })

  /*
  FAKE RANDOM ELEVATION
  let lastp = 500
  geo.geometry.coordinates.forEach(loc => {
    //.geometry
    loc[2]= lastp + _.random(-10, 20);
    lastp = loc[2]
    console.log(loc)
  })*/
});


</script>
</body>
</html>
