<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Geo-Picker</title>
<meta name="description" content="Geospatial data picker via fast http rest interface">
<meta charset="utf-8">
<meta name="format-detection" content="telephone=no">
<meta name="msapplication-tap-highlight" content="no">
<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
<link href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css" rel="stylesheet" type="text/css" />
<link href="//unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" rel="stylesheet" type="text/css" />
<link href="//unpkg.com/leaflet.elevation@0.0.3/dist/Leaflet.Elevation-0.0.2.css" rel="stylesheet" type="text/css" />
<style>
body {
    margin:0
}
#map {
	position: absolute;
	width: 100%;
	top:0;
	bottom:0;
}
.btn-share {
    font-size:16px;
    text-decoration:none;
    display:block;
    text-align:right;
}
.leaflet-popup.loading .leaflet-popup-content {
    background: no-repeat center center url('data:image/gif;base64,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');
    color:rgba(0,0,0,0.2)
}
#ribbon {
	position: absolute;
	top: 0;
	right: 0;
	height: 100px;
	width: auto;
	border: 0;
	filter: alpha(opacity=80);
	-khtml-opacity: .8;
	-moz-opacity: .8;
	opacity: .8;
    z-index:20000
}
.map.mode-create {
    cursor: crosshair;
}
.map div.elbow {
    transition: background-color .25s;
    border: 2px solid white;
    outline: none;
    box-shadow: 0 0 3px rgba(0, 0, 0, .1);
    border-radius: 50%;
    pointer-events: none;
    background-color: #555;
}
.map.mode-edit div.elbow {
    cursor: move;
    pointer-events: all;
    background-color: orangered;
}

.map.mode-delete:not(.mode-append) path {
    cursor: not-allowed;
     z-index: 40000;
}
.map.mode-edit .leaflet-overlay-pane svg {
    position: absolute;
    z-index: 40000;
}
</style>
</head>

<body>

<div id="map">
</div>

<a href="https://github.com/opengeo-tech/geo-picker">
  <img id="ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub">
</a>

<script src="//unpkg.com/underscore@1.9.1/underscore.js"></script>
<script src="//unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
<script src="//unpkg.com/leaflet@1.4.0/dist/leaflet-src.js"></script>
<script src="//unpkg.com/clipboard@2.0.4/dist/clipboard.js"></script>
<script src="//unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="//unpkg.com/d3@3.5.17/d3.min.js"></script>
<script src="//unpkg.com/leaflet.elevation@0.0.3/dist/Leaflet.Elevation-0.0.2.min.js"></script>
<script>

const baseUrl = location.origin;

const center = [46.0651,11.1528]
  , bbox = [4.493408203125001,43.092960677116295,16.896972656250004,48.94415123418794]
  , zoom = 13;

var baselayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
	subdomains: 'abcd',
	minZoom: 8,
	maxZoom: 16,
	ext: 'png'
});

var map = L.map('map', {
  layers: [baselayer],
	center,
	zoom
});

// https://github.com/MrMufflon/Leaflet.Elevation
var controlElevation = new L.Control.Elevation({
  width: 700,
  height: 400,
  position: 'bottomright',
  collapsed: true
}).addTo(map);

var layerElevation = L.geoJson([], {
    style: () => ({
      color: '#00f',
      weight: 2
    }),
    onEachFeature: controlElevation.addData.bind(controlElevation)
}).addTo(map);

var editableLayers = L.featureGroup().addTo(map);

//editLayers
new L.Control.Draw({
  position: 'topleft',
  draw: {
    polyline: {
      shapeOptions: {
          color: '#00f',
          weight: 3
      }
    },
    marker: true,
    circle: false,
    circlemarker: false,
    rectangle: false,
    polygon: false
  },
  edit: {
    featureGroup: editableLayers,
    edit: false,
    remove: false
  }
}).addTo(map);

map
.on('draw:created', e => {
  editableLayers.addLayer(e.layer);
})
.on('draw:drawvertex', e => {
  let geo = e.layers.toGeoJSON();

  let coordinates = geo.features.map(f => {
    return f.geometry.coordinates
  });

  let georeq = {
    type: 'Feature',
    properties: {},
    geometry: {
      type: 'LineString',
      coordinates
    }
  }

  console.log('REQ',georeq.geometry)

  $.ajax({
    url: `${baseUrl}/densify`,
    type: 'POST',
    dataType: 'json',
    contentType: 'application/json; charset=utf-8',
    data: JSON.stringify(georeq),
  }).done(geores => {

    console.log('RES',geores)

    controlElevation.clear();

    layerElevation.addData(geores);

    editableLayers.addLayer(layerElevation);
  });
});


//checkbox to enable mouse picker
const btn = (() => {

    var control = new L.Control({position:'topleft'});

    function pickValue(e) {
      const {latlng} = e
          , [lat, lng] = [latlng.lat, latlng.lng].map(n => L.Util.formatNum(n, 4))
          , url = `${baseUrl}/pixel/${lat}/${lng}`;

      $.getJSON(url).done(res => {
        control._tooltip
          .setLatLng(latlng)
          .setContent(`<b>${res.val}m</b> <br>${res.lat}, ${res.lon}`)
      });
    }

    control.onAdd = map =>  {

      control._tooltip = L.tooltip().setLatLng(map.getCenter()).addTo(map);

      var div = $('<label class="leaflet-control"></label>');
      div.text(' Enable Mouse Picker ');
      div.css({
        float: 'left',
        height: '25px',
        cursor: 'pointer',
        background: '#fff',
      });
      var check = $('<input type="checkbox" />').prependTo(div)

      check.on('change', e => {
        const checked = check.is(':checked');

        if (checked) {
          control._tooltip.setLatLng(map.getCenter()).addTo(map);
          map.on('mousemove', pickValue, this);
        }
        else {
          map.off('mousemove', pickValue, this);
          control._tooltip.removeFrom(map)
        }
      })

      return div[0];
    };
    return control;
  })();

map.addControl(btn);

</script>
</body>
</html>
